<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VTT Translator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --bg:#0f0f0f; --fg:#eee; --box:#1a1a1a; --btn:#1abc9c;
}
.light {
  --bg:#f4f4f4; --fg:#111; --box:#fff; --btn:#3498db;
}
body {
  background:var(--bg); color:var(--fg);
  font-family:Arial; padding:20px;
}
input, textarea, button {
  width:100%; margin:6px 0; padding:10px;
  background:var(--box); color:var(--fg);
  border:1px solid #555;
}
button {
  background:var(--btn); border:0; font-size:16px;
}
textarea { height:240px; }
small { opacity:0.7 }
</style>
</head>

<body>
<h2>ğŸŒ VTT Subtitle Translator</h2>

<button onclick="toggleTheme()">ğŸŒ“ Dark / Light</button>

<input type="file" id="file" accept=".vtt">
<input id="url" placeholder="ğŸ“¡ or VTT URL (https://...)">

<input id="target" value="hr" placeholder="ğŸ¯ Target language (hr, en, de)">

<button onclick="processVTT()">ğŸ” Translate</button>

<textarea id="output" placeholder="Translated VTT..."></textarea>

<button onclick="download()">ğŸ’¾ Download VTT</button>

<small id="info"></small>

<script>
let theme = "dark";
function toggleTheme(){
  document.body.classList.toggle("light");
}

async function fetchVTT() {
  const file = document.getElementById("file").files[0];
  const url = document.getElementById("url").value.trim();
  if (file) return await file.text();
  if (url) return await fetch(url).then(r=>r.text());
  alert("Upload file or enter URL");
}

function detectLanguage(lines){
  for (let l of lines) {
    if (l.toLowerCase().startsWith("language:"))
      return l.split(":")[1].trim();
  }
  return "auto";
}

async function translateBatch(text, target){
  const url =
   `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(text)}`;
  const r = await fetch(url);
  const j = await r.json();
  return j[0].map(x=>x[0]).join("");
}

async function processVTT(){
  const raw = await fetchVTT();
  if (!raw) return;

  const target = document.getElementById("target").value;
  const lines = raw.split(/\r?\n/);
  const sourceLang = detectLanguage(lines);

  let blocks = [];
  let i = 0;
  while (i < lines.length) {
    if (lines[i].includes("-->")) {
      let time = lines[i++];
      let text = [];
      while (i < lines.length && lines[i].trim() !== "") {
        text.push(lines[i++]);
      }
      blocks.push({time, text:text.join(" ")});
    }
    i++;
  }

  document.getElementById("info").innerText =
    `Detected language: ${sourceLang} | Blocks: ${blocks.length}`;

  let output = [
    "WEBVTT",
    "Kind: subtitles",
    `Language: ${target}`,
    ""
  ];

  // ğŸ” BATCH TRANSLATION (5 lines per request)
  for (let i=0;i<blocks.length;i+=5){
    const batch = blocks.slice(i,i+5);
    const joined = batch.map(b=>b.text).join("\n###\n");
    const translated = await translateBatch(joined,target);
    const parts = translated.split("\n###\n");

    batch.forEach((b,idx)=>{
      output.push(b.time);
      output.push(parts[idx] || b.text);
      output.push("");
    });

    await new Promise(r=>setTimeout(r,400)); // rate-limit safety
  }

  document.getElementById("output").value = output.join("\n");
}

function download(){
  const blob = new Blob(
    [document.getElementById("output").value],
    {type:"text/vtt"}
  );
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "translated.vtt";
  a.click();
}
</script>
</body>
</html>
